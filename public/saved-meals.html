<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>저장된 식단 - 잇플</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .back-to-mypage {
      display: inline-block;
      margin: 20px 0;
      padding: 8px 16px;
      background: #f8faff;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      color: #4a69bd;
      text-decoration: none;
      font-weight: 500;
      transition: all 0.2s;
    }
    .back-to-mypage:hover {
      background: #4a69bd;
      color: white;
    }
    
    .saved-meals-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .saved-meals-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-bottom: 18px;
      margin-top: 10px;
      position: relative;
      z-index: 2;
    }
    .saved-meals-title {
      font-size: 2rem;
      font-weight: 700;
      color: #4a69bd;
      margin: 0;
      letter-spacing: -1px;
      text-align: center;
      margin-bottom: 40px;
    }
    .back-btn {
      background: none;
      border: none;
      color: #4a69bd;
      font-size: 1.05rem;
      cursor: pointer;
      text-decoration: underline;
      padding: 2px 8px;
      margin-left: 12px;
      margin-bottom: 2px;
      transition: color 0.2s;
    }
    .back-btn:hover {
      color: #2c3e50;
      text-decoration: underline;
    }
    .saved-meals-grid {
      display: flex;
      flex-wrap: nowrap;
      gap: 24px;
      justify-content: flex-start;
      overflow-x: auto;
      padding-bottom: 12px;
      scrollbar-width: thin;
      scrollbar-color: #b2bec3 #f1f3f5;
      position: relative;
    }
    /* 스크롤바 스타일 (크롬, 엣지, 사파리) */
    .saved-meals-grid::-webkit-scrollbar {
      height: 14px;
    }
    .saved-meals-grid::-webkit-scrollbar-thumb {
      background: #b2bec3;
      border-radius: 7px;
    }
    .saved-meals-grid::-webkit-scrollbar-track {
      background: #f1f3f5;
      border-radius: 7px;
    }
    .saved-meals-flex-row {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      gap: 12px;
      width: 100%;
      margin-bottom: 10px;
    }
    .scroll-arrow-btn {
      width: 40px;
      height: 40px;
      background: #fff;
      border: 1.5px solid #d1d5db;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(42,125,225,0.10);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 2;
      transition: background 0.2s, color 0.2s, border 0.2s;
      padding: 0;
      flex-shrink: 0;
      margin-top: 0;
    }
    .scroll-arrow-btn svg {
      width: 22px;
      height: 22px;
      display: block;
      color: #27408B;
      transition: color 0.2s;
    }
    .scroll-arrow-btn:hover {
      background: #f1f3f5;
      border-color: #27408B;
    }
    .scroll-arrow-btn:hover svg {
      color: #1a2956;
    }
    .saved-meal-card {
      background: white;
      border-radius: 14px;
      box-shadow: 0 2px 10px rgba(42, 125, 225, 0.09);
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
      min-width: 440px;
      max-width: 480px;
      flex: 1 1 460px;
      display: flex;
      flex-direction: column;
      cursor: pointer;
    }
    .saved-meal-card:focus, .saved-meal-card:hover {
      cursor: pointer;
    }
    .saved-meal-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(42, 125, 225, 0.13);
    }
    .saved-meal-header {
      background: #f8f9fa;
      padding: 15px 18px 13px 18px;
      border-bottom: 1px solid #e9ecef;
      position: relative;
      min-height: 48px;
    }
    .saved-meal-title {
      font-size: 1.13rem;
      font-weight: 600;
      margin-bottom: 2px;
      color: #2c3e50;
      word-break: keep-all;
    }
    .saved-meal-date {
      font-size: 13px;
      color: #6c757d;
      margin-bottom: 0;
    }
    .delete-meal-btn {
      position: absolute;
      top: 10px;
      right: 12px;
      background: #e74c3c;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 26px;
      height: 26px;
      cursor: pointer;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
      padding: 0;
      transition: background 0.2s;
    }
    .delete-meal-btn:hover {
      background: #c0392b;
    }
    .saved-meal-content {
      padding: 18px 18px 20px 18px;
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6c757d;
    }
    .empty-state h3 {
      margin-bottom: 10px;
      color: #495057;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }
    .meal-type-badge {
      display: inline-block;
      background: #4a69bd;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      margin-bottom: 10px;
    }
    .nutrition-summary {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #e9ecef;
    }
    .nutrition-summary h4 {
      margin: 0 0 10px 0;
      color: #495057;
      font-size: 16px;
    }
    .nutrition-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      font-size: 14px;
    }
    .nutrition-grid div {
      background: #f8f9fa;
      padding: 6px 10px;
      border-radius: 6px;
      color: #495057;
    }
    
    /* 모바일 반응형 스타일 */
    @media (max-width: 1024px) {
      .saved-meals-container {
        padding: 16px;
      }
      .saved-meals-title {
        font-size: 1.6rem;
        margin-bottom: 24px;
      }
      .saved-meals-grid {
        gap: 18px;
      }
      .saved-meal-card {
        min-width: 360px;
        max-width: 400px;
        flex: 1 1 380px;
      }
      .saved-meal-header {
        padding: 14px 16px 12px 16px;
      }
      .saved-meal-title {
        font-size: 1.05rem;
      }
      .saved-meal-content {
        padding: 16px;
      }
    }

    @media (max-width: 768px) {
      .back-to-mypage {
        margin: 15px 0;
        padding: 10px 14px;
        font-size: 0.9rem;
      }
      .saved-meals-flex-row {
        gap: 8px;
      }
      .scroll-arrow-btn {
        width: 36px;
        height: 36px;
      }
      .scroll-arrow-btn svg {
        width: 20px;
        height: 20px;
      }
      .saved-meals-grid {
        gap: 14px;
        padding-bottom: 10px;
      }
      .saved-meal-card {
        min-width: 300px;
        max-width: 340px;
        flex: 1 1 320px;
        border-radius: 12px;
      }
      .saved-meal-title {
        font-size: 1rem;
      }
      .saved-meal-date {
        font-size: 12px;
      }
      .saved-meal-content {
        padding: 14px;
      }
      .nutrition-grid {
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 6px;
        font-size: 13px;
      }
    }

    @media (max-width: 480px) {
      .saved-meals-container {
        padding: 12px;
      }
      .saved-meals-title {
        font-size: 1.35rem;
        margin-bottom: 18px;
      }
      .saved-meals-flex-row {
        gap: 6px;
      }
      .scroll-arrow-btn {
        width: 34px;
        height: 34px;
      }
      .saved-meals-grid {
        gap: 12px;
      }
      .saved-meal-card {
        min-width: 250px;
        max-width: 280px;
        flex: 1 1 270px;
        border-radius: 12px;
      }
      .saved-meal-header {
        padding: 12px 14px 10px 14px;
        min-height: 44px;
      }
      .saved-meal-title {
        font-size: 0.95rem;
      }
      .saved-meal-date {
        font-size: 11px;
      }
      .delete-meal-btn {
        width: 24px;
        height: 24px;
        font-size: 1rem;
      }
      .saved-meal-content {
        padding: 12px;
        gap: 6px;
      }
      .nutrition-summary h4 {
        font-size: 15px;
      }
      .nutrition-grid {
        grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
        gap: 6px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="site-brand-fixed"><a href="index.html">잇플</a></div>
  
  <div class="saved-meals-container">
    <a href="mypage.html" class="back-to-mypage">← 마이페이지로 돌아가기</a>
    
    <div class="saved-meals-header" style="position:relative;">
      <span class="saved-meals-title">저장된 식단</span>
    </div>
    
    <div class="saved-meals-flex-row" style="margin-top: 0; margin-bottom: 18px;">
      <button class="scroll-arrow-btn" id="scrollLeftBtn">
        <svg viewBox="0 0 40 40" width="28" height="28" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="20" cy="20" r="18" fill="#eaf0fa" stroke="#27408B" stroke-width="2"/>
          <polygon points="23,12 13,20 23,28" fill="#27408B"/>
        </svg>
      </button>
      <div style="flex:1; min-width:0;">
        <div id="savedMealsContent">
          <div class="loading">저장된 식단을 불러오는 중...</div>
        </div>
      </div>
      <button class="scroll-arrow-btn" id="scrollRightBtn">
        <svg viewBox="0 0 40 40" width="28" height="28" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="20" cy="20" r="18" fill="#eaf0fa" stroke="#27408B" stroke-width="2"/>
          <polygon points="17,12 27,20 17,28" fill="#27408B"/>
        </svg>
      </button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      loadSavedMeals();
    });

    async function loadSavedMeals() {
      try {
        const response = await fetch('/api/saved-meals', { credentials: 'include' });
        if (!response.ok) {
          if (response.status === 401) {
            window.location.href = 'login.html';
            return;
          }
          throw new Error('저장된 식단을 불러올 수 없습니다.');
        }
        
        const savedMeals = await response.json();
        displaySavedMeals(savedMeals);
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('savedMealsContent').innerHTML = 
          '<div class="empty-state"><h3>오류가 발생했습니다</h3><p>저장된 식단을 불러올 수 없습니다.</p></div>';
      }
    }

    function displaySavedMeals(meals) {
      const container = document.getElementById('savedMealsContent');
      
      if (!meals || meals.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>저장된 식단이 없습니다</h3>
            <p>AI가 추천한 식단을 저장해보세요!</p>
          </div>
        `;
        return;
      }

      const mealsHtml = meals.map(meal => {
        const mealTypeText = getMealTypeText(meal.mealType);
        const savedDate = new Date(meal.savedAt).toLocaleDateString('ko-KR');
        
        return `
          <div class="saved-meal-card">
            <div class="saved-meal-header">
              <div class="saved-meal-title">${meal.title}</div>
              <div class="saved-meal-date">${savedDate}</div>
              <button class="delete-meal-btn" onclick="deleteMeal('${meal.id}')" title="삭제">×</button>
            </div>
            <div class="saved-meal-content">
              <div class="meal-content">${meal.content}</div>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = `<div class="saved-meals-grid">${mealsHtml}</div>`;
    }

    function getMealTypeText(mealType) {
      const mealTypes = {
        'breakfast': '아침',
        'lunch': '점심',
        'dinner': '저녁',
        'snacks': '간식'
      };
      return mealTypes[mealType] || mealType;
    }

    async function deleteMeal(mealId) {
      if (!confirm('이 식단을 삭제하시겠습니까?')) {
        return;
      }

      try {
        const response = await fetch(`/api/saved-meals/${mealId}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('삭제에 실패했습니다.');
        }

        // 삭제 후 목록 새로고침
        loadSavedMeals();
      } catch (error) {
        console.error('Error:', error);
        alert('삭제에 실패했습니다.');
      }
    }

    // 식단 검색 기능
    let lastSearchedCard = null;
    function searchMealCard() {
      const query = document.getElementById('mealSearchInput').value.trim();
      if (lastSearchedCard) lastSearchedCard.classList.remove('search-highlight');
      if (!query) return;
      const cards = document.querySelectorAll('.saved-meal-card');
      let found = false;
      cards.forEach(card => {
        const text = card.innerText || card.textContent;
        if (!found && text.includes(query)) {
          card.scrollIntoView({ behavior: 'smooth', block: 'center' });
          card.classList.add('search-highlight');
          lastSearchedCard = card;
          found = true;
        }
      });
      if (!found) {
        lastSearchedCard = null;
      }
    }
    document.getElementById('mealSearchInput').addEventListener('input', searchMealCard);
    // 검색 하이라이트 스타일 추가
    const style = document.createElement('style');
    style.innerHTML = `.search-highlight { box-shadow: 0 0 0 4px #ffe066, 0 2px 10px rgba(42,125,225,0.09); transition: box-shadow 0.3s; }`;
    document.head.appendChild(style);

    // 좌우 스크롤 네비게이션
    function scrollSavedMealsGridBy(amount) {
      const grid = document.querySelector('.saved-meals-grid');
      if (grid) {
        grid.scrollBy({ left: amount, behavior: 'smooth' });
      }
    }
    // 좌: 왼쪽, 우: 오른쪽
    document.getElementById('scrollLeftBtn').onclick = function() { scrollSavedMealsGridBy(-460); };
    document.getElementById('scrollRightBtn').onclick = function() { scrollSavedMealsGridBy(460); };
  </script>
  
  <!-- 모바일 하단 네비게이션 바 -->
  <nav class="footer-nav-mobile">
    <ul>
      <li class="footer-nav-item" id="footerNavHome">
        <a href="index.html">
          <span class="footer-nav-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9,22 9,12 15,12 15,22"></polyline>
            </svg>
          </span>
          <span class="footer-nav-label">홈</span>
        </a>
      </li>
      <li class="footer-nav-item" id="footerNavNutrition">
        <a href="nutrition-info.html">
          <span class="footer-nav-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14,2 14,8 20,8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10,9 9,9 8,9"></polyline>
            </svg>
          </span>
          <span class="footer-nav-label">영양정보</span>
        </a>
      </li>
      <li class="footer-nav-item" id="footerNavAI">
        <button type="button" class="footer-nav-ai-btn">
          <span class="footer-nav-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 12l2 2 4-4"></path>
              <path d="M21 12c-1 0-2-1-2-2s1-2 2-2 2 1 2 2-1 2-2 2z"></path>
              <path d="M3 12c1 0 2-1 2-2s-1-2-2-2-2 1-2 2 1 2 2 2z"></path>
              <path d="M12 3c0 1-1 2-2 2s-2-1-2-2 1-2 2-2 2 1 2 2z"></path>
              <path d="M12 21c0-1 1-2 2-2s2 1 2 2-1 2-2 2-2-1-2-2z"></path>
            </svg>
          </span>
          <span class="footer-nav-label">AI기능</span>
        </button>
      </li>
      <li class="footer-nav-item" id="footerNavStore">
        <a href="store.html">
          <span class="footer-nav-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="9" cy="21" r="1"></circle>
              <circle cx="20" cy="21" r="1"></circle>
              <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
            </svg>
          </span>
          <span class="footer-nav-label">스토어</span>
        </a>
      </li>
      <li class="footer-nav-item" id="footerNavMy">
        <a href="mypage.html">
          <span class="footer-nav-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </span>
          <span class="footer-nav-label">마이</span>
        </a>
      </li>
    </ul>
  </nav>

  <!-- AI 기능 모달 -->
  <div id="aiFeatureModal" class="ai-feature-modal">
    <div class="ai-feature-modal-content">
      <ul>
        <li><a href="meal-plan.html">뭐해먹지?</a></li>
        <li><a href="supplements.html">나만의 영양제</a></li>
        <li><a href="restaurant-recommendation.html">오늘의 맛집</a></li>
      </ul>
    </div>
  </div>

  <script>
    // AI 기능 모달 토글 (모바일 하단 내비 전용)
    (function() {
      const aiBtn = document.getElementById('footerNavAI');
      const aiModal = document.getElementById('aiFeatureModal');
      if (aiBtn && aiModal) {
        aiBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          aiModal.classList.toggle('active');
        });
        document.addEventListener('click', function(e) {
          if (aiModal.classList.contains('active') && !aiModal.contains(e.target) && !aiBtn.contains(e.target)) {
            aiModal.classList.remove('active');
          }
        });
      }
    })();
  </script>
</body>
</html> 