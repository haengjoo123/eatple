<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë§ˆì´í˜ì´ì§€</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="mypage.css" />
  </head>
  <body class="mypage-page">
    <div class="site-brand-fixed"><a href="index.html">ì‡í”Œ</a></div>
    <div class="auth-links">
      <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
    </div>
    <div class="container">
      <h1>ë§ˆì´í˜ì´ì§€</h1>
      <button
        id="settingsBtn"
        title="ì„¤ì •"
        onclick="window.location.href='settings.html'"
      >
        <span id="settingsText">ê³„ì •ê´€ë¦¬ ë° ì„¤ì •</span>
      </button>
      <!-- Row 1: í”„ë¡œí•„ ì •ë³´ + ì˜ì–‘ì •ë³´ ë¶ë§ˆí¬ -->
      <div class="mypage-dashboard-row1">
        <div
          class="mypage-card profile-activity-card"
          id="mypageProfileCard"
          tabindex="0"
        >
          <div class="mypage-card-title">
            <span class="profile-icon">ğŸ‘¤</span>
            í”„ë¡œí•„ ì •ë³´
          </div>
          <div class="mypage-card-content">
            <div class="profile-activity-stats">
              <div class="activity-stat-item">
                <div class="activity-icon">âš§ï¸</div>
                <div class="activity-info">
                  <div class="activity-label">ì„±ë³„</div>
                  <div class="activity-count" id="profileGender">-</div>
                </div>
              </div>
              <div class="activity-stat-item">
                <div class="activity-icon">ğŸ‚</div>
                <div class="activity-info">
                  <div class="activity-label">ë‚˜ì´</div>
                  <div class="activity-count" id="profileAge">-</div>
                </div>
              </div>
              <div class="activity-stat-item">
                <div class="activity-icon">ğŸ“</div>
                <div class="activity-info">
                  <div class="activity-label">í‚¤</div>
                  <div class="activity-count" id="profileHeight">-</div>
                </div>
              </div>
              <div class="activity-stat-item">
                <div class="activity-icon">âš–ï¸</div>
                <div class="activity-info">
                  <div class="activity-label">ì²´ì¤‘</div>
                  <div class="activity-count" id="profileWeight">-</div>
                </div>
              </div>
            </div>
            <button
              type="button"
              class="profile-activity-btn"
              onclick="window.location.href='profile.html'"
            >
              <span class="btn-icon">âœï¸</span>
              í”„ë¡œí•„ ìˆ˜ì •í•˜ê¸°
            </button>
          </div>
        </div>
        <div
          class="mypage-card nutrition-activity-card"
          id="mypageNutritionCard"
          tabindex="0"
        >
          <div class="mypage-card-title">
            <span>
              <span class="nutrition-icon">ğŸ“Š</span>
              ì˜ì–‘ì •ë³´ ë¶ë§ˆí¬
            </span>
          </div>
          <div class="mypage-card-content">
            <div
              id="savedNutritionPreview"
              class="saved-nutrition-mini-preview"
              style="
                margin: 12px 0;
                font-size: 0.8rem;
                color: #6b7280;
                text-align: center;
              "
            >
              ë¶ë§ˆí¬í•œ ì˜ì–‘ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤
            </div>
            <div
              id="savedNutritionCount"
              style="
                margin: 12px 0;
                font-size: 0.9rem;
                color: #27408b;
                font-weight: 600;
                text-align: center;
              "
            >
              0ê°œ
            </div>
            <button
              type="button"
              class="nutrition-activity-btn"
              onclick="window.location.href='nutrition.html'"
            >
              <span class="btn-icon">ğŸ“Š</span>
              ì˜ì–‘ì •ë³´ ë³´ëŸ¬ê°€ê¸°
            </button>
          </div>
        </div>
      </div>

      <!-- Row 2: ìŠ¤í† ì–´ í™œë™ + ë‚´ í¬ì¸íŠ¸ -->
      <div class="mypage-dashboard-row2">
        <div
          class="mypage-card store-activity-card"
          id="storeMypageCard"
          tabindex="0"
        >
          <div class="mypage-card-title">
            <span class="store-icon">ğŸ›’</span>
            ìŠ¤í† ì–´ í™œë™
          </div>
          <div class="mypage-card-content">
            <div class="store-activity-stats">
              <div class="activity-stat-item">
                <div class="activity-icon">ğŸ“¦</div>
                <div class="activity-info">
                  <div class="activity-label">ì£¼ë¬¸/ë°°ì†¡</div>
                  <div class="activity-count" id="orderCount">0</div>
                </div>
              </div>
              <div class="activity-stat-item">
                <div class="activity-icon">â¤ï¸</div>
                <div class="activity-info">
                  <div class="activity-label">ì°œí•œìƒí’ˆ</div>
                  <div class="activity-count" id="wishlistCount">0</div>
                </div>
              </div>
              <div class="activity-stat-item">
                <div class="activity-icon">â­</div>
                <div class="activity-info">
                  <div class="activity-label">ë¦¬ë·°</div>
                  <div class="activity-count" id="reviewCount">0</div>
                </div>
              </div>
            </div>
            <button
              type="button"
              id="openStoreMypageBtn"
              class="store-activity-btn"
            >
              <span class="btn-icon">ğŸª</span>
              ìŠ¤í† ì–´ í™œë™ ë³´ê¸°
            </button>
          </div>
        </div>
        <div
          class="mypage-card points-activity-card"
          id="mypagePointsCard"
          tabindex="0"
        >
          <div class="mypage-card-title">
            <span class="points-icon">ğŸ¯</span>
            ë‚´ í¬ì¸íŠ¸
          </div>
          <div class="mypage-card-content">
            <div class="points-activity-stats">
              <div class="activity-stat-item">
                <div class="activity-icon">ğŸ’°</div>
                <div class="activity-info">
                  <div class="activity-label">ë³´ìœ  í¬ì¸íŠ¸</div>
                  <div class="activity-count" id="currentPoints">0P</div>
                </div>
              </div>
            </div>
            <button
              type="button"
              class="points-activity-btn"
              onclick="window.location.href='mini-games.html'"
            >
              <span class="btn-icon">ğŸ®</span>
              ë¯¸ë‹ˆê²Œì„ í•˜ëŸ¬ê°€ê¸°
            </button>
          </div>
        </div>
      </div>

      <!-- Row 3: ì €ì¥ëœ ì‹ë‹¨ + ì¶”ì²œ ì˜ì–‘ì œ -->
      <div class="mypage-dashboard-row3">
        <div
          class="mypage-card meal-activity-card"
          id="mypageSavedMealsCard"
          tabindex="0"
        >
          <div
            class="mypage-card-title"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <span>
              <span class="meal-icon">ğŸ½ï¸</span>
              ì €ì¥ëœ ì‹ë‹¨
            </span>
            <span
              id="savedMealsCount"
              style="font-size: 0.9rem; color: #27408b; font-weight: 600"
              >0ê°œ</span
            >
          </div>
          <div class="mypage-card-content">
            <div
              id="savedMealsPreview"
              class="saved-meals-mini-preview"
              style="
                margin: 12px 0;
                font-size: 0.8rem;
                color: #6b7280;
                text-align: center;
              "
            >
              ì €ì¥ëœ ì‹ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤
            </div>
            <button
              type="button"
              class="meal-activity-btn"
              onclick="window.location.href='meal-plan.html'"
            >
              <span class="btn-icon">ğŸ½ï¸</span>
              ì‹ë‹¨ ê³„íší•˜ê¸°
            </button>
          </div>
        </div>
        <div
          class="mypage-card supplement-activity-card"
          id="mypageSupplementCard"
          tabindex="0"
        >
          <div
            class="mypage-card-title"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <span>
              <span class="supplement-icon">ğŸ’Š</span>
              ë‚˜ë§Œì˜ì˜ ì˜ì–‘ì œ
            </span>
            <span
              id="savedSupplementsCount"
              style="font-size: 0.9rem; color: #27408b; font-weight: 600"
              >0ê°œ</span
            >
          </div>
          <div class="mypage-card-content">
            <div
              id="savedSupplementsPreview"
              class="saved-supplements-mini-preview"
              style="
                margin: 12px 0;
                font-size: 0.8rem;
                color: #6b7280;
                text-align: center;
              "
            >
              ì €ì¥ëœ ì˜ì–‘ì œê°€ ì—†ìŠµë‹ˆë‹¤
            </div>
            <button
              type="button"
              class="supplement-activity-btn"
              onclick="window.location.href='supplement.html'"
            >
              <span class="btn-icon">ğŸ’Š</span>
              ì˜ì–‘ì œ ì¶”ì²œë°›ê¸°
            </button>
          </div>
        </div>
      </div>
      <div class="mypage-stats-row">
        <div class="mypage-card stats-activity-card">
          <div class="mypage-card-title">
            <span class="stats-icon">ğŸ“Š</span>
            ì„œë¹„ìŠ¤ ì´ìš© í†µê³„
          </div>
          <div class="mypage-card-content">
            <div class="stats-activity-grid">
              <div class="activity-stat-item">
                <div class="activity-icon">ğŸ½ï¸</div>
                <div class="activity-info">
                  <div class="activity-label">ì¶”ì²œì‹ë‹¨</div>
                  <div class="activity-count" id="mealPlanCount">0íšŒ</div>
                </div>
              </div>
              <div class="activity-stat-item">
                <div class="activity-icon">ğŸª</div>
                <div class="activity-info">
                  <div class="activity-label">ì¶”ì²œì‹ë‹¹</div>
                  <div class="activity-count" id="restaurantCount">0íšŒ</div>
                </div>
              </div>
              <div class="activity-stat-item">
                <div class="activity-icon">ğŸ’Š</div>
                <div class="activity-info">
                  <div class="activity-label">ì¶”ì²œì˜ì–‘ì œ</div>
                  <div class="activity-count" id="supplementCount">0íšŒ</div>
                </div>
              </div>
              <div class="activity-stat-item">
                <div class="activity-icon">ğŸ”</div>
                <div class="activity-info">
                  <div class="activity-label">ì‹ì¬ë£Œë¶„ì„</div>
                  <div class="activity-count" id="ingredientCount">0íšŒ</div>
                </div>
              </div>
            </div>
            <pre id="stats-debug" style="display: none"></pre>
          </div>
        </div>
      </div>
      <!-- ìŠ¤í† ì–´ ë§ˆì´í˜ì´ì§€ ëª¨ë‹¬ -->
      <div
        id="storeMypageModal"
        class="storeMypage-backdrop"
        aria-hidden="true"
      >
        <div
          class="storeMypage-modal"
          role="dialog"
          aria-modal="true"
          aria-labelledby="storeMypageTitle"
        >
          <div class="storeMypage-header">
            <div class="storeMypage-title" id="storeMypageTitle">
              ìŠ¤í† ì–´ ë§ˆì´í˜ì´ì§€
            </div>
            <button
              class="storeMypage-close"
              id="storeMypageClose"
              aria-label="ë‹«ê¸°"
            >
              Ã—
            </button>
          </div>
          <div class="storeMypage-body">
            <div class="storeMypage-tabs" role="tablist">
              <button
                class="storeMypage-tab active"
                data-tab="orders"
                role="tab"
              >
                ì£¼ë¬¸/ë°°ì†¡
              </button>
              <button class="storeMypage-tab" data-tab="wishlist" role="tab">
                ì°œí•œìƒí’ˆ
              </button>
              <button class="storeMypage-tab" data-tab="reviews" role="tab">
                ë¦¬ë·°
              </button>
            </div>
            <div class="storeMypage-content">
              <div id="storeTab-orders" class="tab active" role="tabpanel">
                <div id="storeOrders" class="storeMypage-list"></div>
              </div>
              <div id="storeTab-wishlist" class="tab" role="tabpanel">
                <div
                  id="storeWishlist"
                  class="storeMypage-list"
                  style="
                    grid-template-columns: repeat(
                      auto-fill,
                      minmax(180px, 1fr)
                    );
                  "
                ></div>
              </div>
              <div id="storeTab-reviews" class="tab" role="tabpanel">
                <div id="storePendingReviews" class="storeMypage-list"></div>
                <hr
                  style="
                    border: none;
                    border-top: 1px solid #eef2f7;
                    margin: 12px 0;
                  "
                />
                <div id="storeMyReviews" class="storeMypage-list"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="script.js"></script>
    <script>
      // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ (ì„œë²„ ì„¸ì…˜ ê¸°ë°˜)
      async function checkAuthStatus() {
        const navAuth = document.getElementById("navAuth");

        try {
          const response = await fetch("/api/auth/me", {
            credentials: "include",
          });
          const data = await response.json();

          if (data.loggedIn && data.user) {
            // ë¡œê·¸ì¸ëœ ìƒíƒœ
            localStorage.setItem("user", JSON.stringify(data.user));

            // ë””ë²„ê¹…: ì‚¬ìš©ì ì •ë³´ ì¶œë ¥
            console.log("ì‚¬ìš©ì ì •ë³´:", data.user);
            console.log("isAdmin:", data.user.isAdmin);
            console.log("role:", data.user.role);

            // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
            let adminButton = "";
            if (data.user.isAdmin === true || data.user.role === "admin") {
              adminButton =
                '<a href="admin.html" class="main-nav-button" style="background-color: #dc3545; color: white;">ê´€ë¦¬ì</a>';
              console.log("ê´€ë¦¬ì ë²„íŠ¼ ì¶”ê°€ë¨");
            } else {
              console.log("ê´€ë¦¬ì ê¶Œí•œ ì—†ìŒ");
            }

            navAuth.innerHTML = `
                    <a href="mypage.html" class="main-nav-button">ë§ˆì´í˜ì´ì§€</a>
                    ${adminButton}
                    <button class="main-nav-button" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                `;
          } else {
            // ë¡œê·¸ì•„ì›ƒëœ ìƒíƒœ
            localStorage.removeItem("token");
            localStorage.removeItem("user");
            navAuth.innerHTML = `
                        <a href="login.html" class="main-nav-button">ë¡œê·¸ì¸</a>
                        <a href="signup.html" class="main-nav-button primary">íšŒì›ê°€ì…</a>
                    `;
          }
        } catch (error) {
          console.error("Auth status check failed:", error);
          // ì—ëŸ¬ ì‹œ ë¡œê·¸ì•„ì›ƒ ìƒíƒœë¡œ í‘œì‹œ
          localStorage.removeItem("token");
          localStorage.removeItem("user");
          navAuth.innerHTML = `
                    <a href="login.html" class="main-nav-button">ë¡œê·¸ì¸</a>
                    <a href="signup.html" class="main-nav-button primary">íšŒì›ê°€ì…</a>
                `;
        }
      }

      async function logout() {
        try {
          await fetch("/api/auth/logout", {
            method: "POST",
            credentials: "include",
          });
        } catch (error) {
          console.error("Logout failed:", error);
        }

        localStorage.removeItem("token");
        localStorage.removeItem("user");
        location.reload();
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
      checkAuthStatus();
    </script>
    <script>
      // ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬
      async function checkAuthStatus() {
        try {
          const response = await fetch("/api/auth/me", {
            credentials: "include",
          });
          const data = await response.json();

          if (!data.loggedIn) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.");
            window.location.href = "login.html";
            return false;
          }
          return true;
        } catch (error) {
          console.error("ì¸ì¦ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:", error);
          alert("ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
          window.location.href = "login.html";
          return false;
        }
      }

      document.addEventListener("DOMContentLoaded", async function () {
        // ë¨¼ì € ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬
        const isLoggedIn = await checkAuthStatus();
        if (!isLoggedIn) return;
        var profileCard = document.getElementById("mypageProfileCard");
        if (profileCard) {
          profileCard.addEventListener("click", function () {
            window.location.href = "profile.html";
          });
          profileCard.addEventListener("keydown", function (e) {
            if (e.key === "Enter" || e.key === " ") {
              window.location.href = "profile.html";
            }
          });
        }
        var settingsBtn = document.getElementById("settingsBtn");
        if (settingsBtn) {
          settingsBtn.addEventListener("click", function () {
            window.location.href = "settings.html";
          });
        }

        // ìŠ¤í† ì–´ ë§ˆì´í˜ì´ì§€ ëª¨ë‹¬ ë°”ì¸ë”©
        const storeCard = document.getElementById("storeMypageCard");
        const openStoreBtn = document.getElementById("openStoreMypageBtn");
        const storeModal = document.getElementById("storeMypageModal");
        const storeClose = document.getElementById("storeMypageClose");

        let lastFocusedElement; // í¬ì»¤ìŠ¤ ì¶”ì ì„ ìœ„í•œ ë³€ìˆ˜

        function openStoreMypageModal() {
          // ëª¨ë‹¬ì´ ì—´ë¦¬ê¸° ì „ í˜„ì¬ í¬ì»¤ìŠ¤ëœ ìš”ì†Œë¥¼ ì €ì¥
          lastFocusedElement = document.activeElement;
          // íƒ­ ì´ˆê¸°í™” í›„ ë°ì´í„° ë¡œë“œ
          switchStoreTab("orders");
          loadStoreOrders();
          loadStoreWishlist();
          loadStoreReviews();
          storeModal.classList.add("active");
          storeModal.setAttribute("aria-hidden", "false");
          // ëª¨ë‹¬ì´ ì—´ë¦¬ë©´ ë‹«ê¸° ë²„íŠ¼ì— í¬ì»¤ìŠ¤
          storeClose.focus();
        }

        function closeStoreMypageModal() {
          storeModal.classList.remove("active");
          storeModal.setAttribute("aria-hidden", "true");
          // ëª¨ë‹¬ì´ ë‹«íˆë©´ ì´ì „ì— í¬ì»¤ìŠ¤ëœ ìš”ì†Œë¡œ í¬ì»¤ìŠ¤ ë³µì›
          if (lastFocusedElement) {
            lastFocusedElement.focus();
          }
        }

        function switchStoreTab(name) {
          document
            .querySelectorAll(".storeMypage-tab")
            .forEach((t) => t.classList.remove("active"));
          document
            .querySelectorAll(".storeMypage-content .tab")
            .forEach((c) => c.classList.remove("active"));
          const tabBtn = document.querySelector(
            `.storeMypage-tab[data-tab="${name}"]`
          );
          const tabPanel = document.getElementById(`storeTab-${name}`);
          if (tabBtn) tabBtn.classList.add("active");
          if (tabPanel) tabPanel.classList.add("active");
        }

        // ì´ë²¤íŠ¸ ì—°ê²°
        if (storeCard) {
          storeCard.addEventListener("click", openStoreMypageModal);
          storeCard.addEventListener("keydown", function (e) {
            if (e.key === "Enter" || e.key === " ") openStoreMypageModal();
          });
        }
        if (openStoreBtn)
          openStoreBtn.addEventListener("click", function (e) {
            e.stopPropagation();
            openStoreMypageModal();
          });
        if (storeClose)
          storeClose.addEventListener("click", closeStoreMypageModal);
        if (storeModal)
          storeModal.addEventListener("click", function (e) {
            if (e.target === storeModal) closeStoreMypageModal();
          });

        // íƒ­ ë²„íŠ¼ í´ë¦­
        document.addEventListener("click", function (e) {
          const btn = e.target.closest(".storeMypage-tab");
          if (!btn) return;
          const name = btn.getAttribute("data-tab");
          switchStoreTab(name);
        });

        // ë°ì´í„° ë¡œë“œ: ìŠ¤í† ì–´ API ì¬ì‚¬ìš©
        async function loadStoreOrders() {
          try {
            const res = await fetch("/api/shop/orders", {
              credentials: "include",
            });
            const data = await res.json();
            const list = document.getElementById("storeOrders");
            if (!list) return;
            if (!data.success || !data.data || data.data.length === 0) {
              list.innerHTML =
                '<div class="storeMypage-empty">ì£¼ë¬¸/ë°°ì†¡ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
              return;
            }
            list.innerHTML = data.data
              .map(
                (o) => `
              <div class="storeMypage-cardRow">
                <div>
                  <div style="font-weight:700;color:#27408b;">ì£¼ë¬¸ì¼: ${new Date(
                    o.created_at
                  ).toLocaleDateString("ko-KR")}</div>
                  <div style="font-size:0.9rem;color:#475569;">ìƒí’ˆ ${
                    o.items?.length || 0
                  }ê°œ Â· ê²°ì œ ${(
                  o.final_amount ?? o.total_amount
                ).toLocaleString()}ì›</div>
                </div>
                <div class="storeMypage-orderStatus">${getStoreStatusText(
                  o.status
                )}</div>
              </div>`
              )
              .join("");
          } catch (err) {
            console.error("ìŠ¤í† ì–´ ì£¼ë¬¸ ë¡œë“œ ì˜¤ë¥˜:", err);
            const list = document.getElementById("storeOrders");
            if (list)
              list.innerHTML =
                '<div class="storeMypage-empty">ì£¼ë¬¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
          }
        }

        function getStoreStatusText(status) {
          const map = {
            pending: "ì£¼ë¬¸ í™•ì¸ì¤‘",
            processing: "ì¤€ë¹„ì¤‘",
            shipped: "ë°°ì†¡ì¤‘",
            delivered: "ë°°ì†¡ì™„ë£Œ",
          };
          return map[status] || "ì£¼ë¬¸ í™•ì¸ì¤‘";
        }

        async function loadStoreWishlist() {
          try {
            const res = await fetch("/api/shop/wishlist", {
              credentials: "include",
            });
            const data = await res.json();
            const grid = document.getElementById("storeWishlist");
            if (!grid) return;
            if (!data.success || !data.data || data.data.length === 0) {
              grid.innerHTML =
                '<div class="storeMypage-empty">ì°œí•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</div>';
              return;
            }
            grid.innerHTML = data.data
              .map(
                (w) => `
              <div class="storeMypage-cardRow" style="flex-direction:column; align-items:stretch;">
                <div style="display:flex; gap:10px; align-items:center;">
                  <div style="font-size:1.4rem;">${
                    getCategoryEmoji(w.category) || "ğŸ“¦"
                  }</div>
                  <div style="flex:1;">
                    <div style="font-weight:700;color:#27408b;">${
                      w.name || "ìƒí’ˆëª… ì—†ìŒ"
                    }</div>
                    <div style="color:#475569;">${
                      w.price ? w.price.toLocaleString() : "0"
                    }ì›</div>
                  </div>
                </div>
              </div>`
              )
              .join("");
          } catch (err) {
            console.error("ìŠ¤í† ì–´ ì°œ ë¡œë“œ ì˜¤ë¥˜:", err);
            const grid = document.getElementById("storeWishlist");
            if (grid)
              grid.innerHTML =
                '<div class="storeMypage-empty">ì°œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
          }
        }

        async function loadStoreReviews() {
          try {
            const [pendingRes, myRes] = await Promise.all([
              fetch("/api/shop/reviews/pending", { credentials: "include" }),
              fetch("/api/shop/reviews/my", { credentials: "include" }),
            ]);
            const [pendingData, myData] = await Promise.all([
              pendingRes.json(),
              myRes.json(),
            ]);
            const pending = pendingData.success ? pendingData.data : [];
            const mine = myData.success ? myData.data : [];
            const pendingEl = document.getElementById("storePendingReviews");
            const myEl = document.getElementById("storeMyReviews");
            if (pendingEl) {
              pendingEl.innerHTML =
                pending.length === 0
                  ? '<div class="storeMypage-empty">ì‘ì„± ê°€ëŠ¥í•œ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤</div>'
                  : pending
                      .map(
                        (p) => `
                    <div class="storeMypage-cardRow">
                      <div>
                        <div style="font-weight:700;color:#27408b;">${
                          p.product_name || "ìƒí’ˆëª… ì—†ìŒ"
                        }</div>
                        <div style="color:#475569;">ë°°ì†¡ ì™„ë£Œ ìƒí’ˆ</div>
                      </div>
                      <button style="padding:8px 10px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;" onclick="window.location.href='cart.html'">ë¦¬ë·° ì‘ì„±</button>
                    </div>`
                      )
                      .join("");
            }
            if (myEl) {
              myEl.innerHTML =
                mine.length === 0
                  ? '<div class="storeMypage-empty">ì‘ì„±í•œ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤</div>'
                  : mine
                      .map(
                        (r) => `
                    <div class="storeMypage-cardRow" style="align-items:flex-start;">
                      <div>
                        <div style="font-weight:700;color:#27408b;">${
                          r.product_name || "ìƒí’ˆëª… ì—†ìŒ"
                        }</div>
                        <div class="storeMypage-reviewRating">${"â˜…".repeat(
                          r.rating
                        )}${"â˜†".repeat(5 - r.rating)}</div>
                        <div style="color:#475569;">${r.content || ""}</div>
                      </div>
                    </div>`
                      )
                      .join("");
            }
          } catch (err) {
            console.error("ìŠ¤í† ì–´ ë¦¬ë·° ë¡œë“œ ì˜¤ë¥˜:", err);
            const pendingEl = document.getElementById("storePendingReviews");
            const myEl = document.getElementById("storeMyReviews");
            if (pendingEl)
              pendingEl.innerHTML =
                '<div class="storeMypage-empty">ë¦¬ë·° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
            if (myEl) myEl.innerHTML = "";
          }
        }

        function getCategoryEmoji(category) {
          const map = {
            ë¹„íƒ€ë¯¼: "ğŸŸ¡",
            ë¯¸ë„¤ë„: "ğŸŸ¢",
            ì˜¤ë©”ê°€: "ğŸ”µ",
            í”„ë¡œë°”ì´ì˜¤í‹±ìŠ¤: "ğŸŸ£",
            í—ˆë¸Œ: "ğŸŸ¤",
            ê¸°íƒ€: "âšª",
          };
          return map[category];
        }
        // í”„ë¡œí•„ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
        fetch("/api/profile", { credentials: "include" })
          .then((res) => res.json())
          .then((profile) => {
            document.getElementById("profileGender").textContent =
              profile.gender === "male"
                ? "ë‚¨ì„±"
                : profile.gender === "female"
                ? "ì—¬ì„±"
                : "-";
            document.getElementById("profileAge").textContent =
              profile.age || "-";
            document.getElementById("profileHeight").textContent =
              profile.height ? profile.height + "cm" : "-";
            document.getElementById("profileWeight").textContent =
              profile.weight ? profile.weight + "kg" : "-";
          });

        // ì €ì¥ëœ ì‹ë‹¨ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
        fetch("/api/saved-meals", { credentials: "include" })
          .then((res) => res.json())
          .then((savedMeals) => {
            const countElement = document.getElementById("savedMealsCount");
            const previewElement = document.getElementById("savedMealsPreview");
            if (savedMeals.length === 0) {
              countElement.style.display = "none";
              previewElement.textContent = "ì €ì¥ëœ ì‹ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤";
            } else {
              countElement.style.display = "block";
              countElement.textContent = `ì €ì¥ëœ ì‹ë‹¨: ${savedMeals.length}ê°œ`;
              // ìµœì‹  3ê°œë§Œ ë¯¸ë‹ˆì¹´ë“œë¡œ ë³´ì—¬ì£¼ê¸°
              const mealTypeEmoji = {
                breakfast: "ğŸ",
                lunch: "ğŸš",
                dinner: "ğŸ²",
                snacks: "ğŸ",
              };
              previewElement.innerHTML = savedMeals
                .slice(0, 5)
                .map((meal) => {
                  const emoji = mealTypeEmoji[meal.mealType] || "ğŸ½ï¸";
                  const savedDate = new Date(meal.savedAt).toLocaleDateString(
                    "ko-KR"
                  );

                  // ì£¼ì¬ë£Œì—ì„œ ì²« ë²ˆì§¸ ì¬ë£Œ ì¶”ì¶œ
                  let mainIngredient = "ì£¼ì¬ë£Œ";
                  try {
                    const tempDiv = document.createElement("div");
                    tempDiv.innerHTML = meal.content;
                    const ingredientList = tempDiv.querySelector(
                      ".main-ingredient-title + .ingredient-list"
                    );
                    if (ingredientList) {
                      const firstIngredient =
                        ingredientList.querySelector(".ingredient-name");
                      if (firstIngredient) {
                        mainIngredient = firstIngredient.textContent
                          .split("(")[0]
                          .trim(); // ê´„í˜¸ ì•ë¶€ë¶„ë§Œ ì¶”ì¶œ
                      }
                    }
                  } catch (e) {
                    console.log("ì¬ë£Œ ì¶”ì¶œ ì‹¤íŒ¨:", e);
                  }

                  return `<div class="mini-meal-card" tabindex="0" onclick="window.location.href='saved-meals.html'">
                <div class="mini-meal-title"><span class="mini-meal-emoji">${emoji}</span>${meal.title}</div>
                <div class="mini-meal-ingredient">${mainIngredient}</div>
                <div class="mini-meal-date">${savedDate}</div>
              </div>`;
                })
                .join("");
            }
          });

        // ë¶ë§ˆí¬í•œ ì˜ì–‘ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
        // ë¶ë§ˆí¬ ê°œìˆ˜ ì¡°íšŒ
        fetch("/api/nutrition-info/bookmarks/count", { credentials: "include" })
          .then((res) => {
            if (res.ok) {
              return res.json();
            } else {
              console.log("ë¶ë§ˆí¬ ê°œìˆ˜ ì¡°íšŒ ì‹¤íŒ¨:", res.status);
              return { success: false, count: 0 };
            }
          })
          .then((countResponse) => {
            const countElement = document.getElementById("savedNutritionCount");
            const totalCount = countResponse.success ? countResponse.count : 0;
            
            // ë¶ë§ˆí¬ ëª©ë¡ ì¡°íšŒ (ë¯¸ë¦¬ë³´ê¸°ìš©)
            return fetch("/api/nutrition-info/bookmarks?limit=5", { credentials: "include" })
              .then((res) => {
                if (res.ok) {
                  return res.json();
                } else {
                  console.log("ë¶ë§ˆí¬ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:", res.status);
                  return { success: false, data: [] };
                }
              })
              .then((listResponse) => {
                const previewElement = document.getElementById("savedNutritionPreview");
                const bookmarkedNutrition = listResponse.success ? listResponse.data : [];

                if (totalCount === 0) {
                  if (countElement) countElement.style.display = "none";
                  if (previewElement)
                    previewElement.textContent = "ë¶ë§ˆí¬í•œ ì˜ì–‘ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤";
                } else {
                  if (countElement) {
                    countElement.style.display = "block";
                    countElement.textContent = `ë¶ë§ˆí¬í•œ ì •ë³´: ${totalCount}ê°œ`;
                  }
                  // ìµœì‹  5ê°œë§Œ ë¯¸ë‹ˆì¹´ë“œë¡œ ë³´ì—¬ì£¼ê¸°
                  const categoryEmoji = {
                    ë¹„íƒ€ë¯¼: "ğŸŸ¡",
                    ë¯¸ë„¤ë„: "ğŸŸ¢",
                    ë‹¨ë°±ì§ˆ: "ğŸ”´",
                    íƒ„ìˆ˜í™”ë¬¼: "ğŸŸ¤",
                    ì§€ë°©: "ğŸŸ ",
                    ì‹ì´ì„¬ìœ : "ğŸŸ¢",
                    í•­ì‚°í™”: "ğŸŸ£",
                    ê¸°íƒ€: "âšª",
                  };
                  if (previewElement) {
                    previewElement.innerHTML = bookmarkedNutrition
                      .slice(0, 5)
                      .map((nutrition) => {
                        const emoji = categoryEmoji[nutrition.category] || "ğŸ“š";
                        const savedDate = new Date(
                          nutrition.createdAt || nutrition.publishedAt
                        ).toLocaleDateString("ko-KR");

                        return `<div class="mini-nutrition-card" tabindex="0" onclick="window.location.href='bookmarked-nutrition.html'">
                      <div class="mini-nutrition-title"><span class="mini-nutrition-emoji">${emoji}</span>${nutrition.title}</div>
                      <div class="mini-nutrition-category">${nutrition.category}</div>
                      <div class="mini-nutrition-date">${savedDate}</div>
                    </div>`;
                      })
                      .join("");
                  }
                }
              });
          })
          .catch((error) => {
            console.error("ë¶ë§ˆí¬ ì˜ì–‘ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:", error);
            const countElement = document.getElementById("savedNutritionCount");
            const previewElement = document.getElementById(
              "savedNutritionPreview"
            );
            if (countElement) countElement.style.display = "none";
            if (previewElement)
              previewElement.textContent = "ë¶ë§ˆí¬í•œ ì˜ì–‘ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤";
          });

        // ì €ì¥ëœ ì˜ì–‘ì œ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
        fetch("/api/supplements/saved-supplements", { credentials: "include" })
          .then((res) => res.json())
          .then((savedSupplements) => {
            const countElement = document.getElementById(
              "savedSupplementsCount"
            );
            const previewElement = document.getElementById(
              "savedSupplementsPreview"
            );
            if (savedSupplements.length === 0) {
              countElement.style.display = "none";
              previewElement.textContent = "ì €ì¥ëœ ì˜ì–‘ì œê°€ ì—†ìŠµë‹ˆë‹¤";
            } else {
              countElement.style.display = "block";
              countElement.textContent = `ì €ì¥ëœ ì˜ì–‘ì œ: ${savedSupplements.length}ê°œ`;
              // ìµœì‹  5ê°œë§Œ ë¯¸ë‹ˆì¹´ë“œë¡œ ë³´ì—¬ì£¼ê¸°
              const categoryEmoji = {
                ë¹„íƒ€ë¯¼: "ï¿½",
                ë¯¸ë„¤ë„: "ï¿½",
                ì˜¤ë©”ê°€: "ğŸ”µ",
                í”„ë¡œë°”ì´ì˜¤í‹±ìŠ¤: "ğŸŸ£",
                í—ˆë¸Œ: "ğŸŸ¤",
                ê¸°íƒ€: "âšª",
              };
              previewElement.innerHTML = savedSupplements
                .slice(0, 5)
                .map((supplement) => {
                  const emoji = categoryEmoji[supplement.category] || "ğŸ’Š";
                  const savedDate = new Date(
                    supplement.savedAt
                  ).toLocaleDateString("ko-KR");

                  return `<div class="mini-supplement-card" tabindex="0" onclick="window.location.href='saved-supplements.html'">
                <div class="mini-supplement-title"><span class="mini-supplement-emoji">${emoji}</span>${supplement.name}</div>
                <div class="mini-supplement-category">${supplement.category}</div>
                <div class="mini-supplement-date">${savedDate}</div>
              </div>`;
                })
                .join("");
            }
          });

        // ë¶ë§ˆí¬í•œ ì˜ì–‘ì •ë³´ ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸
        var savedNutritionCard = document.getElementById("mypageNutritionCard");
        if (savedNutritionCard) {
          savedNutritionCard.addEventListener("click", function () {
            window.location.href = "bookmarked-nutrition.html";
          });
          savedNutritionCard.addEventListener("keydown", function (e) {
            if (e.key === "Enter" || e.key === " ") {
              window.location.href = "bookmarked-nutrition.html";
            }
          });
        }

        // ì €ì¥ëœ ì˜ì–‘ì œ ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸
        var savedSupplementsCard = document.getElementById(
          "mypageSupplementCard"
        );
        if (savedSupplementsCard) {
          savedSupplementsCard.addEventListener("click", function () {
            window.location.href = "saved-supplements.html";
          });
          savedSupplementsCard.addEventListener("keydown", function (e) {
            if (e.key === "Enter" || e.key === " ") {
              window.location.href = "saved-supplements.html";
            }
          });
        }

        // ì €ì¥ëœ ì‹ë‹¨ ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸
        var savedMealsCard = document.getElementById("mypageSavedMealsCard");
        if (savedMealsCard) {
          savedMealsCard.addEventListener("click", function () {
            window.location.href = "saved-meals.html";
          });
          savedMealsCard.addEventListener("keydown", function (e) {
            if (e.key === "Enter" || e.key === " ") {
              window.location.href = "saved-meals.html";
            }
          });
        }

        function getMealTypeText(mealType) {
          const mealTypes = {
            breakfast: "ì•„ì¹¨",
            lunch: "ì ì‹¬",
            dinner: "ì €ë…",
            snacks: "ê°„ì‹",
          };
          return mealTypes[mealType] || mealType;
        }

        // í¬ì¸íŠ¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
        fetch("/api/points/balance", { credentials: "include" })
          .then((res) => {
            if (res.ok) {
              return res.json();
            } else {
              console.log("í¬ì¸íŠ¸ ì¡°íšŒ ì‹¤íŒ¨:", res.status);
              return { balance: 0 };
            }
          })
          .then((data) => {
            document.getElementById("currentPoints").textContent =
              data.balance || 0;
          })
          .catch((error) => {
            console.error("í¬ì¸íŠ¸ ì¡°íšŒ ì˜¤ë¥˜:", error);
            document.getElementById("currentPoints").textContent = "0";
          });

        // í¬ì¸íŠ¸ ë‚´ì—­ì€ ìˆ¨ê¹€ ì²˜ë¦¬ (í•„ìš”ì‹œ ë‚˜ì¤‘ì— í™œì„±í™”)
        const historyElement = document.getElementById("pointsHistory");
        if (historyElement) {
          historyElement.style.display = "none";
        }

        // í¬ì¸íŠ¸ ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸
        var pointsCard = document.getElementById("mypagePointsCard");
        if (pointsCard) {
          pointsCard.addEventListener("click", function () {
            window.location.href = "mini-games.html";
          });
          pointsCard.addEventListener("keydown", function (e) {
            if (e.key === "Enter" || e.key === " ") {
              window.location.href = "mini-games.html";
            }
          });
        }

        // ì„œë¹„ìŠ¤ ì´ìš© í†µê³„ ë¶ˆëŸ¬ì˜¤ê¸°
        fetch("/api/stats/my", { credentials: "include" })
          .then((res) => {
            console.log("í†µê³„ API ì‘ë‹µ ìƒíƒœ:", res.status);
            if (res.ok) {
              return res.json();
            } else {
              console.log("í†µê³„ ì¡°íšŒ ì‹¤íŒ¨:", res.status, res.statusText);
              return null;
            }
          })
          .then((data) => {
            console.log("í†µê³„ ë°ì´í„°:", data);
            if (data && data.serviceUsage) {
              const usage = data.serviceUsage;
              console.log("ì„œë¹„ìŠ¤ ì‚¬ìš©ëŸ‰ ë°ì´í„°:", usage);

              const mealPlanElement = document.getElementById("mealPlanCount");
              const restaurantElement =
                document.getElementById("restaurantCount");
              const supplementElement =
                document.getElementById("supplementCount");
              const ingredientElement =
                document.getElementById("ingredientCount");

              if (mealPlanElement)
                mealPlanElement.textContent = `${usage.mealPlan || 0}íšŒ`;
              if (restaurantElement)
                restaurantElement.textContent = `${
                  usage.restaurantRecommendation || 0
                }íšŒ`;
              if (supplementElement)
                supplementElement.textContent = `${
                  usage.supplementRecommendation || 0
                }íšŒ`;
              if (ingredientElement)
                ingredientElement.textContent = `${
                  usage.ingredientAnalysis || 0
                }íšŒ`;
            } else {
              console.log("í†µê³„ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ êµ¬ì¡°ê°€ ë‹¤ë¦…ë‹ˆë‹¤:", data);
            }
          })
          .catch((error) => {
            console.error("í†µê³„ ì¡°íšŒ ì˜¤ë¥˜:", error);
          });

        // ëª¨ë°”ì¼ í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” í™œì„±í™”
        const footerNavMy = document.getElementById("footerNavMy");
        if (footerNavMy) {
          footerNavMy.classList.add("active");
        }

        // AI ê¸°ëŠ¥ ëª¨ë‹¬ ì²˜ë¦¬
        const aiFeatureBtn = document.querySelector(".footer-nav-ai-btn");
        const aiFeatureModal = document.getElementById("aiFeatureModal");

        if (aiFeatureBtn && aiFeatureModal) {
          aiFeatureBtn.addEventListener("click", function (e) {
            e.preventDefault();
            aiFeatureModal.classList.toggle("active");
          });

          // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
          document.addEventListener("click", function (e) {
            if (
              !aiFeatureBtn.contains(e.target) &&
              !aiFeatureModal.contains(e.target)
            ) {
              aiFeatureModal.classList.remove("active");
            }
          });
        }
      });
    </script>

    <!-- ëª¨ë°”ì¼ í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <nav class="footer-nav-mobile">
      <ul>
        <li class="footer-nav-item" id="footerNavHome">
          <a href="index.html">
            <span class="footer-nav-icon">ğŸ </span>
            <span class="footer-nav-label">í™ˆ</span>
          </a>
        </li>
        <li class="footer-nav-item" id="footerNavNutrition">
          <a href="nutrition-info.html">
            <span class="footer-nav-icon">ğŸ“°</span>
            <span class="footer-nav-label">ì˜ì–‘ì •ë³´</span>
          </a>
        </li>
        <li class="footer-nav-item" id="footerNavAI">
          <button type="button" class="footer-nav-ai-btn">
            <span class="footer-nav-icon">ğŸ¤–</span>
            <span class="footer-nav-label">AIê¸°ëŠ¥</span>
          </button>
        </li>
        <li class="footer-nav-item" id="footerNavStore">
          <a href="store.html">
            <span class="footer-nav-icon">ğŸ›’</span>
            <span class="footer-nav-label">ìŠ¤í† ì–´</span>
          </a>
        </li>
        <li class="footer-nav-item" id="footerNavMy">
          <a href="mypage.html" class="active">
            <span class="footer-nav-icon">ğŸ‘¤</span>
            <span class="footer-nav-label">ë§ˆì´</span>
          </a>
        </li>
      </ul>
    </nav>

    <!-- AI ê¸°ëŠ¥ ëª¨ë‹¬ -->
    <div id="aiFeatureModal" class="ai-feature-modal">
      <div class="ai-feature-modal-content">
        <ul>
          <li><a href="meal-plan.html">ë­í•´ë¨¹ì§€?</a></li>
          <li><a href="supplements.html">ë‚˜ë§Œì˜ ì˜ì–‘ì œ</a></li>
          <li><a href="restaurant-recommendation.html">ì˜¤ëŠ˜ì˜ ë§›ì§‘</a></li>
        </ul>
      </div>
    </div>
  </body>
</html>
