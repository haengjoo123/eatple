<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>비밀번호 재설정 - 잇플</title>
    <link rel="stylesheet" href="auth-style.css" />
  </head>
  <body>
    <div class="site-brand-fixed">
      <a href="index.html">
        <img src="images/eatplelogo.png" alt="잇플" class="logo-image">
      </a>
    </div>

    <div class="auth-container">
      <h2>비밀번호 재설정</h2>
      <form id="resetPasswordForm">
        <div class="input-row-icon">
          <span class="input-icon">
            <svg
              width="20"
              height="20"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <rect
                x="4"
                y="8"
                width="12"
                height="8"
                rx="2"
                stroke="#b0b8c1"
                stroke-width="1.5"
              />
              <path
                d="M7 8V6a3 3 0 1 1 6 0v2"
                stroke="#b0b8c1"
                stroke-width="1.5"
              />
            </svg>
          </span>
          <input
            type="password"
            id="newPassword"
            name="newPassword"
            placeholder="새 비밀번호"
            required
            autocomplete="new-password"
          />
        </div>

        <ul id="passwordRules" class="password-rules" style="display: none">
          <li data-rule="length">
            <span class="rule-icon">✗</span> 영문/숫자/특수문자 2가지 이상 조합
            (8~20자)
          </li>
          <li data-rule="repeat">
            <span class="rule-icon">✗</span> 3개 이상 연속되거나 동일한
            문자/숫자 제외
          </li>
        </ul>

        <div class="input-row-icon">
          <span class="input-icon">
            <svg
              width="20"
              height="20"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <rect
                x="4"
                y="8"
                width="12"
                height="8"
                rx="2"
                stroke="#b0b8c1"
                stroke-width="1.5"
              />
              <path
                d="M7 8V6a3 3 0 1 1 6 0v2"
                stroke="#b0b8c1"
                stroke-width="1.5"
              />
            </svg>
          </span>
          <input
            type="password"
            id="confirmPassword"
            name="confirmPassword"
            placeholder="새 비밀번호 확인"
            required
            autocomplete="new-password"
          />
        </div>
        <div id="passwordConfirmMsg" class="password-confirm-msg"></div>

        <button type="submit">비밀번호 변경</button>
      </form>

      <div class="auth-link">
        <a href="login.html">로그인으로 돌아가기</a>
      </div>

      <div id="resetMsg"></div>
    </div>

    <script>
      // URL에서 토큰 추출 (Supabase 형식 지원)
      const urlParams = new URLSearchParams(window.location.search);
      const hash = window.location.hash.substring(1);
      const hashParams = new URLSearchParams(hash);

      // URL 파라미터 또는 해시에서 토큰 추출
      const accessToken =
        urlParams.get("access_token") || hashParams.get("access_token");
      const refreshToken =
        urlParams.get("refresh_token") || hashParams.get("refresh_token");
      const error = urlParams.get("error") || hashParams.get("error");
      const errorDescription =
        urlParams.get("error_description") ||
        hashParams.get("error_description");
      const type = urlParams.get("type") || hashParams.get("type");

      const msg = document.getElementById("resetMsg");

      console.log("URL 파라미터 확인:", {
        accessToken: accessToken ? "있음" : "없음",
        refreshToken: refreshToken ? "있음" : "없음",
        error: error,
        type: type,
        fullURL: window.location.href,
      });

      // 에러가 있는 경우
      if (error) {
        msg.style.color = "red";
        msg.textContent =
          errorDescription || "비밀번호 재설정 링크가 유효하지 않습니다.";
        document.getElementById("resetPasswordForm").style.display = "none";
      }
      // 비밀번호 재설정 타입이 아닌 경우
      else if (type && type !== "recovery") {
        msg.style.color = "red";
        msg.textContent = "잘못된 링크 타입입니다.";
        document.getElementById("resetPasswordForm").style.display = "none";
      }
      // 토큰이 없는 경우
      else if (!accessToken && !error) {
        msg.style.color = "red";
        msg.textContent = "유효하지 않은 비밀번호 재설정 링크입니다.";
        document.getElementById("resetPasswordForm").style.display = "none";
      }
      // 정상적인 경우
      else if (accessToken) {
        msg.style.color = "green";
        msg.textContent = "새로운 비밀번호를 입력해주세요.";
      }

      // 비밀번호 재설정 폼 처리
      document.getElementById("resetPasswordForm").onsubmit = async function (
        e
      ) {
        e.preventDefault();

        const newPassword = document.getElementById("newPassword").value;
        const confirmPassword =
          document.getElementById("confirmPassword").value;

        // 클라이언트 측 유효성 검사
        if (!newPassword || !confirmPassword) {
          msg.style.color = "red";
          msg.textContent = "모든 항목을 입력하세요.";
          return;
        }

        if (newPassword !== confirmPassword) {
          msg.style.color = "red";
          msg.textContent = "비밀번호가 일치하지 않습니다.";
          return;
        }

        if (!validatePassword(newPassword)) {
          msg.style.color = "red";
          msg.textContent = "비밀번호 조건을 확인해주세요.";
          return;
        }

        // 토큰 재확인
        if (!accessToken) {
          msg.style.color = "red";
          msg.textContent = "유효하지 않은 재설정 링크입니다.";
          return;
        }

        try {
          msg.style.color = "blue";
          msg.textContent = "비밀번호를 변경하는 중...";

          // Supabase 클라이언트를 통한 비밀번호 업데이트
          const response = await fetch("/api/auth/update-password", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              accessToken: accessToken,
              refreshToken: refreshToken,
              newPassword: newPassword,
            }),
            credentials: "include",
          });

          const data = await response.json();

          if (data.success) {
            msg.style.color = "green";
            msg.textContent = "비밀번호가 성공적으로 변경되었습니다.";

            // 폼 비활성화
            document.getElementById("resetPasswordForm").style.display = "none";

            setTimeout(() => {
              window.location.href =
                "login.html?message=" +
                encodeURIComponent(
                  "비밀번호가 변경되었습니다. 새 비밀번호로 로그인해주세요."
                );
            }, 2000);
          } else {
            msg.style.color = "red";
            msg.textContent = data.error || "비밀번호 변경에 실패했습니다.";
          }
        } catch (err) {
          console.error("Password reset error:", err);
          msg.style.color = "red";
          msg.textContent = "서버 오류가 발생했습니다.";
        }
      };

      // 비밀번호 유효성 검사 함수
      function validatePassword(password) {
        // 영문/숫자/특수문자 2가지 이상 조합 확인
        const hasLetter = /[a-zA-Z]/.test(password);
        const hasNumber = /[0-9]/.test(password);
        const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(
          password
        );
        const combinationCount = [hasLetter, hasNumber, hasSpecial].filter(
          Boolean
        ).length;

        const rules = {
          length:
            password.length >= 8 &&
            password.length <= 20 &&
            combinationCount >= 2,
          repeat: !hasRepeatingChars(password),
        };

        updatePasswordRules(rules);
        return Object.values(rules).every((rule) => rule);
      }

      // 연속/반복 문자 검사
      function hasRepeatingChars(password) {
        for (let i = 0; i < password.length - 2; i++) {
          if (
            password[i] === password[i + 1] &&
            password[i + 1] === password[i + 2]
          ) {
            return true;
          }
        }

        for (let i = 0; i < password.length - 2; i++) {
          const char1 = password.charCodeAt(i);
          const char2 = password.charCodeAt(i + 1);
          const char3 = password.charCodeAt(i + 2);

          if (char2 === char1 + 1 && char3 === char2 + 1) {
            return true;
          }
        }

        return false;
      }

      // 비밀번호 규칙 UI 업데이트
      function updatePasswordRules(rules) {
        const passwordRulesEl = document.getElementById("passwordRules");
        if (!passwordRulesEl) return;

        Object.keys(rules).forEach((rule) => {
          const ruleEl = passwordRulesEl.querySelector(`[data-rule="${rule}"]`);
          if (ruleEl) {
            const icon = ruleEl.querySelector(".rule-icon");
            if (rules[rule]) {
              icon.textContent = "✓";
              icon.style.color = "#2ecc40";
              ruleEl.style.color = "#2ecc40";
            } else {
              icon.textContent = "✗";
              icon.style.color = "#e74c3c";
              ruleEl.style.color = "#e74c3c";
            }
          }
        });
      }

      // 실시간 비밀번호 검증
      document.addEventListener("DOMContentLoaded", function () {
        const newPasswordInput = document.getElementById("newPassword");
        const confirmPasswordInput = document.getElementById("confirmPassword");
        const passwordRules = document.getElementById("passwordRules");

        if (newPasswordInput) {
          newPasswordInput.addEventListener("focus", function () {
            if (passwordRules) {
              passwordRules.style.display = "block";
            }
          });

          newPasswordInput.addEventListener("input", function () {
            const password = this.value;
            if (password) {
              validatePassword(password);
            }

            if (confirmPasswordInput && confirmPasswordInput.value) {
              validatePasswordConfirm();
            }
          });
        }

        if (confirmPasswordInput) {
          confirmPasswordInput.addEventListener(
            "input",
            validatePasswordConfirm
          );
        }

        function validatePasswordConfirm() {
          const password = newPasswordInput.value;
          const passwordConfirm = confirmPasswordInput.value;
          const confirmMsg = document.getElementById("passwordConfirmMsg");

          if (passwordConfirm) {
            if (password === passwordConfirm) {
              confirmMsg.textContent = "비밀번호가 일치합니다.";
              confirmMsg.style.color = "green";
            } else {
              confirmMsg.textContent = "비밀번호가 일치하지 않습니다.";
              confirmMsg.style.color = "red";
            }
          } else {
            confirmMsg.textContent = "";
          }
        }
      });
    </script>
  </body>
</html>
